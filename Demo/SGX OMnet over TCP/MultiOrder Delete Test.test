<?xml version="1.1" encoding="ASCII"?>
<TestUnit:TestContainerType xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:CertificationCommands="com.esprow.nozomi.testunit.commands.certification" xmlns:TestUnit="com.esprow.nozomi.testunit" formatVersion="2.1">
  <test comment="This certification test checks the querying of reference data (DQ124)." loggingLevel="DEBUG" certificationUnit="true" dictionary="SGX_OMnet" implementsBridgeMode="true">
    <testCommand xsi:type="CertificationCommands:CreateMessageRelayCommand" targetSystemId="%CONFIGURATIONS.CERTIFICATION.SYSTEM%" targetHandlerId="%CONFIGURATIONS.CERTIFICATION.DESTINATION%" forwardSystemId="%CONFIGURATIONS.CERTIFICATION.BRIDGE.SYSTEM%" forwardHandlerId="%CONFIGURATIONS.CERTIFICATION.BRIDGE.DESTINATION%" filterShowOnly="true" validateMessages="true">
      <messageTypeFilters>MO4</messageTypeFilters>
      <messageTypeFilters>TRANSACTION_ANSWER</messageTypeFilters>
      <messageTypeFilters>BO5</messageTypeFilters>
    </testCommand>
    <testCommand xsi:type="TestUnit:LogEntry" disabled="true" text="# Step 1"/>
    <testCommand xsi:type="TestUnit:ClearMessageQueue" messageSenderProducer="//@test/@testCommand.0" incoming="false" outgoing="true"/>
    <testCommand xsi:type="TestUnit:NewVar" variableId="Orders_Placed" value="10"/>
    <testCommand xsi:type="TestUnit:GetInteractiveFeedbackCommand">
      <instructionMultiLanguage key="en" value="Please delete the remaining %VARIABLES.Orders_Placed% active Limit orders placed in the first step using MO4 transaction(s). After the MO4(s), make sure that you receive BO5 broadcast(s) with information about the deletion (if your system supports that)."/>
    </testCommand>
    <testCommand xsi:type="TestUnit:IfStatementCommand">
      <testCommand xsi:type="TestUnit:IfThenElseStatementBlock" logicStatement="%CONFIGURATIONS.API_Order% || %CONFIGURATIONS.API_Market_Making%">
        <testCommand xsi:type="TestUnit:NewVar" variableId="Orders_Remaining" value="%VARIABLES.Orders_Placed%"/>
        <testCommand xsi:type="TestUnit:WhileLoopCommand" logicStatement="%VARIABLES.Orders_Remaining%>0" maxIterationSafety="">
          <testCommand xsi:type="TestUnit:NewVar" variableId="Orders_Deleted" value="0"/>
          <testCommand xsi:type="TestUnit:WaitCommand" messageId="MO4" messageSenderProducer="//@test/@testCommand.0" messageCount="1" timeout="-1" searchFromLastMatch="true" searchFromLastMatchCombined="true" removeMatched="true">
            <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="delete_trans_t[].delete_trans_t.transaction_type[].transaction_type_t.central_module_c" value="M" fieldType="Char"/>
            <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="delete_trans_t[].delete_trans_t.transaction_type[].transaction_type_t.server_type_c" value="O" fieldType="Char"/>
            <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="delete_trans_t[].delete_trans_t.transaction_type[].transaction_type_t.transaction_number_n" value="4" fieldType="BigDecimal"/>
            <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="delete_trans_t[].delete_trans_t.series[].series_t.country_c" value="%CONFIGURATIONS.Series_Country%" fieldType="BigDecimal"/>
            <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="delete_trans_t[].delete_trans_t.series[].series_t.market_c" value="%CONFIGURATIONS.Series_Market%" fieldType="BigDecimal"/>
            <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="delete_trans_t[].delete_trans_t.series[].series_t.commodity_n" value="%CONFIGURATIONS.Series_Commodity%" fieldType="BigDecimal"/>
            <messageType>MO4</messageType>
          </testCommand>
          <testCommand xsi:type="TestUnit:WaitCommand" messageId="MO4_Response" messageSenderProducer="//@test/@testCommand.0" messageCount="1" timeout="-1" searchFromLastMatch="true" searchFromLastMatchCombined="true" outgoingMessage="true" removeMatched="true">
            <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="StandardHeader.header_response_t[].header_response_t.return_value_i" value="0" checkType="GREATER_OR_EQUAL" fieldType="Integer"/>
            <messageType>TRANSACTION_ANSWER</messageType>
          </testCommand>
          <testCommand xsi:type="TestUnit:IfStatementCommand">
            <testCommand xsi:type="TestUnit:IfThenElseStatementBlock" logicStatement="%MESSAGES.MO4.delete_trans_t[].delete_trans_t.order_number_u%!=0">
              <testCommand xsi:type="TestUnit:LogEntry" disabled="true" text="If the MO4 has order_number_u specified, it's a single-order deletion"/>
              <testCommand xsi:type="TestUnit:NewVar" variableId="Orders_Deleted" value="1"/>
            </testCommand>
            <testCommand xsi:type="TestUnit:IfThenElseStatementBlock" logicStatement="isExpanded(&quot;%MESSAGES.MO4.delete_trans_t[].delete_trans_t.whose[].whose_t.trading_code[].trading_code_t.ex_customer_s%&quot;) &amp;&amp; length(&quot;%MESSAGES.MO4.delete_trans_t[].delete_trans_t.whose[].whose_t.trading_code[].trading_code_t.ex_customer_s%&quot;)>0">
              <testCommand xsi:type="TestUnit:LogEntry" disabled="true" text="For multi-order deletion, the 2 least significant bytes of txstat contain the number of deleted orders"/>
              <testCommand xsi:type="TestUnit:NewVar" variableId="Response_Txstat" value="%MESSAGES.MO4_Response.StandardHeader.header_response_t[].header_response_t.txstat_i%"/>
              <testCommand xsi:type="TestUnit:NewVar" variableId="Orders_Deleted" value="IEEEremainder(%VARIABLES.Response_Txstat%,65536)"/>
            </testCommand>
          </testCommand>
          <testCommand xsi:type="TestUnit:NewVar" variableId="Orders_Remaining" value="%VARIABLES.Orders_Remaining%-%VARIABLES.Orders_Deleted%"/>
          <testCommand xsi:type="TestUnit:GetInteractiveFeedbackCommand">
            <instructionMultiLanguage key="en" value="%VARIABLES.Orders_Deleted% order(s) deleted, %VARIABLES.Orders_Remaining% order(s) remaining."/>
          </testCommand>
        </testCommand>
      </testCommand>
    </testCommand>
    <testCommand xsi:type="TestUnit:GetInteractiveFeedbackCommand" variableId="Response" requireUserInput="true">
      <instructionMultiLanguage key="en" value="Did the MO4 transaction(s) complete successfully?&#xD;&#xA;(Enter y for yes, n for no)"/>
    </testCommand>
    <testCommand xsi:type="TestUnit:IfStatementCommand">
      <testCommand xsi:type="TestUnit:IfThenElseStatementBlock" logicStatement="eval(&quot;! equalsIgnoreCase(&quot;%VARIABLES.Response%&quot;, &quot;y&quot;) &amp;&amp; ! equalsIgnoreCase(&quot;%VARIABLES.Response%&quot;, &quot;yes&quot;)&quot;)">
        <testCommand xsi:type="TestUnit:FailCommand" text="The MO4 transaction(s) should have completed successfully."/>
      </testCommand>
    </testCommand>
    <testCommand xsi:type="TestUnit:WaitCommand" messageSenderProducer="//@test/@testCommand.0" messageCount="1" timeout="-1" searchFromLastMatch="false" outgoingMessage="true" removeMatched="true">
      <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="broadcast_hdr_t[].broadcast_hdr_t.broadcast_type[].broadcast_type_t.central_module_c" value="B" fieldType="Char"/>
      <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="broadcast_hdr_t[].broadcast_hdr_t.broadcast_type[].broadcast_type_t.server_type_c" value="O" fieldType="Char"/>
      <testCommand xsi:type="TestUnit:CreateFieldValueCheckCommand" path="broadcast_hdr_t[].broadcast_hdr_t.broadcast_type[].broadcast_type_t.transaction_number_n" value="5" fieldType="BigDecimal"/>
      <messageType>BO5</messageType>
    </testCommand>
    <testCommand xsi:type="TestUnit:GetInteractiveFeedbackCommand" variableId="Response" requireUserInput="true">
      <instructionMultiLanguage key="en" value="Did you receive BO5 broadcast(s) with information that all the remaining orders have been deleted?&#xD;&#xA;(Enter y for yes, n for no)"/>
    </testCommand>
    <testCommand xsi:type="TestUnit:IfStatementCommand">
      <testCommand xsi:type="TestUnit:IfThenElseStatementBlock" logicStatement="eval(&quot;! equalsIgnoreCase(&quot;%VARIABLES.Response%&quot;, &quot;y&quot;) &amp;&amp; ! equalsIgnoreCase(&quot;%VARIABLES.Response%&quot;, &quot;yes&quot;)&quot;)">
        <testCommand xsi:type="TestUnit:FailCommand" text="You should have received BO5 broadcast(s) with information that all the remaining orders have been deleted."/>
      </testCommand>
    </testCommand>
  </test>
</TestUnit:TestContainerType>
